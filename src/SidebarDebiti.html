<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
    
    <style>
      :root {
        --bg-main: #FEEFFC;
        --button-bg: #FFA6AF;
        --accent-fuchsia: #FD7094;
        --text-dark: #000000;
        --text-light: #555555;
        --card-bg: #FFFFFF;
      }
      
      html, body { height: 100%; margin: 0; }
      body { 
        font-family: 'Poppins', 'Helvetica Neue', Arial, sans-serif;
        background-color: var(--bg-main);
        color: var(--text-dark);
        display: flex;
        flex-direction: column;
        min-height: 100%;
      }
      
      .container {
        max-width: 400px;
        width: 90%;
        margin: 0 auto;
        padding: 15px 0;
        flex: 1 1 auto;
        padding-bottom: 160px; /* Spazio per il footer */
      }
      
      .footer-bar {
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        padding: 15px;
        background-color: var(--bg-main);
        z-index: 10;
        max-width: 400px;
        margin: 0 auto;
        left: 50%;
        transform: translateX(-50%);
        width: 100%;
      }
      #status { margin-top: 15px; font-weight: bold; }
      
      .card-style {
        margin-bottom: 20px;
        padding: 25px 20px;
        border-radius: 20px;
        position: relative;
        overflow: hidden;
        color: var(--text-dark);
        /* Neuromorphic style */
        --color: var(--bg-main);
        --radius: 20px;
        --elevation: 8px; 
        --bevel: 0.5px;
        --angle: 225deg;
        --intensity: 56;
        --diffusion: 54;
        --sin: calc(sin(var(--angle)));
        --cos: calc(cos(var(--angle)));
        --x-displacement: calc(-1 * var(--cos) * (var(--elevation) + 1px));
        --y-displacement: calc(-1 * var(--sin) * (var(--elevation) + 1px));
        --edge-opacity: calc(var(--intensity) * 0.006 - var(--diffusion) * 0.002);
        --edge-blur: calc(var(--bevel) * 1.5);
        --surface-contrast: calc(var(--intensity) * 0.01 - var(--diffusion) * 0.005);
        box-shadow: var(--x-displacement) var(--y-displacement) calc(var(--diffusion) * 0.3px + (var(--elevation))) calc(var(--elevation) / 2) rgba(0, 0, 0, calc(var(--intensity) * 0.006)),
                    0px 0px calc(var(--diffusion) * 1.4px) rgba(255, 255, 255, calc(var(--intensity) * 0.004)),
                    inset calc(var(--bevel) * -1) 0 var(--edge-blur) hsla(100, 0%, calc((var(--cos) + 1) * 50%), var(--edge-opacity)),
                    inset 0 var(--bevel) var(--edge-blur) hsla(100, 0%, calc((-1 * var(--sin) + 1) * 50%), var(--edge-opacity)),
                    inset var(--bevel) 0 var(--edge-blur) hsla(100, 0%, calc((-1 * var(--cos) + 1) * 50%), var(--edge-opacity)),
                    inset 0 calc(var(--bevel) * -1) var(--edge-blur) hsla(100, 0%, calc((var(--sin) + 1) * 50%), var(--edge-opacity));
        background: linear-gradient(
          calc(var(--angle) + 90deg),
          rgba(0, 0, 0, var(--surface-contrast)),
          rgba(255, 255, 255, var(--surface-contrast))
          ),
          var(--color);
        background-blend-mode: soft-light;
      }
      
      .card-style h5 { 
        margin-bottom: 10px; 
        font-weight: 600;
      }

      .debito-item { padding: 5px 0; margin-left: 20px; }

      .button {
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 18px 25px;
        margin: 10px 0;
        background-color: var(--button-bg);
        color: var(--text-dark);
        text-decoration: none;
        border-radius: 15px;
        font-weight: 600;
        font-size: 1.1rem;
        cursor: pointer;
        transition: all 0.25s ease;
        position: relative;
        overflow: hidden;
        box-shadow: 0 0 0 2px var(--accent-fuchsia) inset,
                    0 4px 12px rgba(0,0,0,0.08);
        border: none;
        width: 100%;
      }
      .button:hover { 
        color: var(--card-bg);
        text-decoration: none;
        transform: translateY(-2px);
        background-color: var(--accent-fuchsia);
        box-shadow: 0 0 0 2px var(--accent-fuchsia) inset,
                    0 6px 18px rgba(0,0,0,0.12);
      }

      .form-check {
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .form-check-input {
        appearance: none;
        -webkit-appearance: none;
        background-color: transparent;
        border: 2px solid var(--accent-fuchsia);
        border-radius: 5px;
        width: 18px;
        height: 18px;
        cursor: pointer;
        position: relative;
        margin: 0;
        flex-shrink: 0;
        transition: all 0.25s ease;
        display: inline-block;
        vertical-align: middle;
      }

      .form-check-input:checked {
        background-color: var(--accent-fuchsia);
        border-color: var(--accent-fuchsia);
      }

      .form-check-input:checked::after {
        content: 'âœ“';
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -52%);
        color: #fff;
        font-size: 12px;
        font-weight: bold;
        line-height: 1;
      }

      .form-check-label {
        font-size: 0.95rem;
        line-height: 1.2;
        cursor: pointer;
      }

      .form-check-input:hover {
        box-shadow: 0 0 0 3px rgba(253, 112, 148, 0.25);
      }

      .pagato label {
        text-decoration: line-through;
        opacity: 0.5;
        transition: all 0.3s ease;
      }

      /* Stili Modal */
      .modal-content {
        background-color: var(--bg-main);
        border-radius: 20px;
        border: none;
      }
      .modal-header {
        color: var(--text-dark);
      }
      .modal-footer .button {
        font-size: 1rem;
        padding: 12px 20px;
      }
      #messaggio-content {
        white-space: pre-wrap;
        word-wrap: break-word;
        font-family: 'Poppins', 'Helvetica', Arial, sans-serif;
        font-size: 1rem;
        color: var(--text-dark);
        border: 1px solid var(--accent-fuchsia);
        border-radius: 8px;
        padding: 15px;
      }
      #modal-loader { text-align: center; padding: 20px; }
    </style>
  </head>
  <body>
    <div class="container">
      <div id="loader">
        <p>Caricamento debiti...</p>
      </div>
      
      <div id="status"></div>
      
      <h5 id="debiti-title" class="mt-3" style="display: none;">Debiti Giocatori</h5>
      <div id="debiti-container"></div>
      
      <!-- Footer Bar -->
      <div class="footer-bar" id="footer-bar" style="display: none;">
        <button type="button" class="button mb-2" onclick="showPagamentiMessage()">
          genera messaggio
        </button>
        <button id="salva-spunte-btn" class="button">
          salva
        </button>
      </div>
    </div>
    
    <!-- Modal per Messaggio Chiodi -->
    <div class="modal fade" id="pagamentiModal" tabindex="-1" role="dialog" aria-labelledby="pagamentiModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="pagamentiModalLabel">ðŸ“‰ Messaggio Chiodi</h5>
            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
              <span aria-hidden="true">&times;</span>
            </button>
          </div>
          <div class="modal-body">
            <div id="modal-loader" style="display: none;">
              <p>Caricamento messaggio...</p>
            </div>
            <pre id="messaggio-content" style="display: none;"></pre>
          </div>
          <div class="modal-footer">
            <button type="button" class="button" onclick="copiaMessaggio()">ðŸ“‹ Copia Messaggio</button>
          </div>
        </div>
      </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
    <script>
      // 1. All'avvio, carica i dati
      document.addEventListener("DOMContentLoaded", function() {
        loadData();
        
        // Listener per il bottone Salva Spunte
        document.getElementById("salva-spunte-btn").addEventListener("click", salvaSpunte);
      });

      function loadData() {
        document.getElementById('loader').style.display = 'block';
        document.getElementById('debiti-container').innerHTML = '';
        // document.getElementById('debiti-title').style.display = 'none';
        document.getElementById('footer-bar').style.display = 'none';
        document.getElementById('status').innerHTML = '';
        
        google.script.run.withSuccessHandler(onDataLoaded).getDebitiData();
      }

      // 2. Costruisce l'interfaccia
      function onDataLoaded(response) {
        document.getElementById('loader').style.display = 'none';
        const container = document.getElementById('debiti-container');
        const status = document.getElementById('status');
        
        if (!response.success) {
          status.innerHTML = `<div class="alert alert-danger">${response.message}</div>`;
          document.getElementById('footer-bar').style.display = 'block'; // Mostra footer per vedere msg
          return;
        }

        // Mostra il footer
        document.getElementById('footer-bar').style.display = 'block';

        const debitori = response.data;
        if (debitori.length === 0) {
          status.innerHTML = `<div class="alert alert-success">ðŸŽ‰ Tutti i pagamenti sono in regola!</div>`;
        } else {
           status.innerHTML = '';
          //  document.getElementById('debiti-title').style.display = 'block';
        }

        debitori.forEach(player => {
          const playerDiv = document.createElement('div');
          playerDiv.className = 'card-style'; 
          let html = `<h5>${player.cognome}</h5>`;
          player.debiti.forEach(debito => {
            html += `
              <div class="form-check debito-item" id="item-${debito.cellaSpunta}">
                <input class="form-check-input" type="checkbox" 
                       value="${debito.cellaSpunta}" 
                       id="check-${debito.cellaSpunta}"
                       onchange="togglePagato(this)">
                <label class="form-check-label" for="check-${debito.cellaSpunta}">
                  ${debito.match}: <strong>${debito.importo.toFixed(2)}â‚¬</strong>
                </label>
              </div>
            `;
          });
          playerDiv.innerHTML = html;
          container.appendChild(playerDiv);
        });
      }
      
      // 3. Gestisce il click sulla spunta (VISUALE)
      function togglePagato(checkbox) {
        const itemDiv = document.getElementById(`item-${checkbox.value}`);
        if (checkbox.checked) {
          itemDiv.classList.add('pagato');
        } else {
          itemDiv.classList.remove('pagato');
        }
      }

      // 4. Gestisce il click su "Salva Spunte"
      function salvaSpunte() {
        const btn = document.getElementById("salva-spunte-btn");
        const status = document.getElementById('status');
        status.innerHTML = ''; 
        
        const checkedBoxes = document.querySelectorAll('#debiti-container input[type="checkbox"]:checked');
        const celleA1 = Array.from(checkedBoxes).map(cb => cb.value);
        
        if (celleA1.length === 0) {
          status.innerHTML = `<div class="alert alert-warning">Nessuna spunta selezionata.</div>`;
          return;
        }
        
        btn.disabled = true;
        status.innerHTML = `<div class="alert alert-info">Salvataggio in corso...</div>`;
        google.script.run.withSuccessHandler(onSalvaSpunteComplete).setPagamentiSpuntatiBatch(celleA1);
      }

      // 5. Gestisce la risposta del salvataggio
      function onSalvaSpunteComplete(response) {
        const status = document.getElementById('status');
        if (response.success) {
          status.innerHTML = `<div class="alert alert-success">${response.message || 'Operazioni salvate!'}</div>`;
          // Ricarica i dati
          loadData(); 
        } else {
          status.innerHTML = `<div class="alert alert-danger">Errore: ${response.message}</div>`;
        }
        document.getElementById('salva-spunte-btn').disabled = false;
      }

      // --- FUNZIONI PER MODAL MESSAGGIO ---

      // 6. Funzione per mostrare il modal
      function showPagamentiMessage() {
        $('#pagamentiModal').modal('show');
        document.getElementById('modal-loader').style.display = 'block';
        document.getElementById('messaggio-content').style.display = 'none';
        google.script.run.withSuccessHandler(onMessageReceived).ottieniMessaggioPagamenti();
      }

      // 7. Callback dopo aver ricevuto il messaggio
      function onMessageReceived(messaggio) {
        document.getElementById('modal-loader').style.display = 'none';
        const content = document.getElementById('messaggio-content');
        content.textContent = messaggio;
        content.style.display = 'block';
      }

      // 8. Funzione per copiare il messaggio
      function copiaMessaggio() {
        const textToCopy = document.getElementById('messaggio-content').textContent;
        navigator.clipboard.writeText(textToCopy).then(function() {
          alert('Messaggio copiato!');
        }, function(err) {
          alert('Errore: Impossibile copiare il messaggio.');
        });
      }
    </script>
  </body>
</html>
