<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/7.0.1/css/all.min.css" integrity="sha512-2SwdPD6INVrV/lHTZbO2nodKhrnDdJK9/kg2XD1r9uGqPo1cUbujc+IYdlYdEErWNu69gVcYgdxlmVmzTWnetw==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
    
    <style>
      :root {
        --bg-main: #FEEFFC;
        --button-bg: #FFA6AF;
        --accent-fuchsia: #FD7094;
        --text-dark: #000000;
        --text-light: #555555;
        --card-bg: #FFFFFF;
      }
      
      html, body { height: 100%; margin: 0; }
      body { 
        font-family: 'Poppins', 'Helvetica Neue', Arial, sans-serif;
        background-color: var(--bg-main);
        color: var(--text-dark);
        display: flex;
        flex-direction: column;
        min-height: 100%;
      }
      
      .container {
        max-width: 400px;
        width: 90%;
        margin: 0 auto;
        padding: 15px 0;
        flex: 1 1 auto;
      }
      
      #status { 
        margin-top: 15px; 
        font-weight: bold; 
      }
      
      .card-style {
        margin-bottom: 20px;
        padding: 25px 20px;
        border-radius: 20px;
        position: relative;
        overflow: hidden;
        color: var(--text-dark);
        /* Neuromorphic style */
        --color: var(--bg-main);
        --radius: 20px;
        --elevation: 8px; 
        --bevel: 0.5px;
        --angle: 225deg;
        --intensity: 56;
        --diffusion: 54;
        --sin: calc(sin(var(--angle)));
        --cos: calc(cos(var(--angle)));
        --x-displacement: calc(-1 * var(--cos) * (var(--elevation) + 1px));
        --y-displacement: calc(-1 * var(--sin) * (var(--elevation) + 1px));
        --edge-opacity: calc(var(--intensity) * 0.006 - var(--diffusion) * 0.002);
        --edge-blur: calc(var(--bevel) * 1.5);
        --surface-contrast: calc(var(--intensity) * 0.01 - var(--diffusion) * 0.005);
        box-shadow: var(--x-displacement) var(--y-displacement) calc(var(--diffusion) * 0.3px + (var(--elevation))) calc(var(--elevation) / 2) rgba(0, 0, 0, calc(var(--intensity) * 0.006)),
                    0px 0px calc(var(--diffusion) * 1.4px) rgba(255, 255, 255, calc(var(--intensity) * 0.004)),
                    inset calc(var(--bevel) * -1) 0 var(--edge-blur) hsla(100, 0%, calc((var(--cos) + 1) * 50%), var(--edge-opacity)),
                    inset 0 var(--bevel) var(--edge-blur) hsla(100, 0%, calc((-1 * var(--sin) + 1) * 50%), var(--edge-opacity)),
                    inset var(--bevel) 0 var(--edge-blur) hsla(100, 0%, calc((-1 * var(--cos) + 1) * 50%), var(--edge-opacity)),
                    inset 0 calc(var(--bevel) * -1) var(--edge-blur) hsla(100, 0%, calc((var(--sin) + 1) * 50%), var(--edge-opacity));
        background: linear-gradient(
          calc(var(--angle) + 90deg),
          rgba(0, 0, 0, var(--surface-contrast)),
          rgba(255, 255, 255, var(--surface-contrast))
          ),
          var(--color);
        background-blend-mode: soft-light;
      }
      
      .card-style h5 { 
        margin-bottom: 10px; 
        font-weight: 600;
      }
      
      .form-control {
        background-color: var(--bg-main);
        border: 1px solid var(--accent-fuchsia);
        border-radius: 10px;
        padding: 10px 15px;
        font-family: 'Poppins', sans-serif;
        color: var(--text-dark);
        width: 100%;
        box-sizing: border-box;
      }
      .form-control:focus {
        background-color: var(--bg-main);
        color: var(--text-dark);
        border-color: var(--accent-fuchsia);
        box-shadow: 0 0 0 3px rgba(253, 112, 148, 0.25);
      }
      .form-control::placeholder {
        color: var(--text-light);
        opacity: 1;
      }
      /* select.form-control {
        padding: 8px 12px;
        line-height: 1.2;
        appearance: none;
        -webkit-appearance: none;
        background-position: right 10px center;
        background-repeat: no-repeat;
        background-size: 16px;
      } */
      select.form-control {
        appearance: none;
        -webkit-appearance: none;
        -moz-appearance: none;
        background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 12 8' fill='none' stroke='%23FD7094' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpath d='M1 1l5 5 5-5'/%3e%3c/svg%3e");
        background-repeat: no-repeat;
        background-position: right 15px center;
        background-size: 12px;
        padding-right: 40px;
        padding-top: 8px;
        padding-bottom: 8px;
        line-height: 1.2;
      }

      .form-check {
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .form-check-input {
        appearance: none;
        -webkit-appearance: none;
        background-color: transparent;
        border: 2px solid var(--accent-fuchsia);
        border-radius: 5px;
        width: 18px;
        height: 18px;
        cursor: pointer;
        position: relative;
        margin: 0;
        flex-shrink: 0;
        transition: all 0.25s ease;
        display: inline-block;
        vertical-align: middle;
      }

      .form-check-input:checked {
        background-color: var(--accent-fuchsia);
        border-color: var(--accent-fuchsia);
      }

      .form-check-input:checked::after {
        content: '✓';
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -52%);
        color: #fff;
        font-size: 12px;
        font-weight: bold;
        line-height: 1;
      }

      .form-check-label {
        font-size: 0.95rem;
        line-height: 1.2;
        cursor: pointer;
      }

      .form-check-input:hover {
        box-shadow: 0 0 0 3px rgba(253, 112, 148, 0.25);
      }

      .button {
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 18px 25px;
        margin: 10px 0;
        background-color: var(--button-bg);
        color: var(--text-dark);
        text-decoration: none;
        border-radius: 15px;
        font-weight: 600;
        font-size: 1.1rem;
        cursor: pointer;
        transition: all 0.25s ease;
        position: relative;
        overflow: hidden;
        box-shadow: 0 0 0 2px var(--accent-fuchsia) inset,
                    0 4px 12px rgba(0,0,0,0.08);
        border: none;
        width: 100%;
      }
      .button i {
        margin-right: 10px;
        color: var(--text-dark);
        font-size: 1.2em;
      }
      .button:hover { 
        color: var(--card-bg);
        text-decoration: none;
        transform: translateY(-2px);
        background-color: var(--accent-fuchsia);
        box-shadow: 0 0 0 2px var(--accent-fuchsia) inset,
                    0 6px 18px rgba(0,0,0,0.12);
      }
       .button:hover i {
        color: var(--card-bg);
      }
      
      /* Override Bootstrap badge */
      .badge-primary {
        background-color: var(--accent-fuchsia);
        color: var(--card-bg);
      }
      
      #player-list { 
        margin-top: 10px; 
      }
      #player-list .form-check {
        margin-left: 10px;
        padding: 2px 0;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div id="loader">
        <p>Caricamento dati...</p>
      </div>

      <div id="match-info" class="card-style" style="display: none; text-align: center;"></div>
      
      <div id="main-content" class="card-style" style="display: none;">
        
        <h5>Seleziona Convocati <span id="player-counter" class="badge badge-primary">0</span></h5>
        <div id="player-list"></div>

        <h5 class="mt-3">Staff</h5>
        <!-- <label for="coach-select">Allenatore</label> -->
        <select id="coach-select" class="form-control mb-2"></select>
        
        <!-- <label for="director-select">Dirigente Accompagnatore</label> -->
        <select id="director-select" class="form-control mb-2"></select>
        
        <button id="generate-btn" class="button mt-3">
          genera distinta
        </button>
        
        <div id="status"></div>
      </div>
    </div>

    <script>
      let nextMatchData = null;

      // Load all data with a single call when the sidebar opens
      document.addEventListener("DOMContentLoaded", function() {
        google.script.run.withSuccessHandler(onDataLoaded).getSidebarDistintaData();
      });

      function onDataLoaded(data) {
        nextMatchData = data.nextMatch;

        // Populate Match Info
        const matchDiv = document.getElementById("match-info");
        // ADDED card-style class
        matchDiv.className = "card-style";
        
        if (nextMatchData) {
          matchDiv.innerHTML = `<h5 style="font-weight: 600;">Prossima Partita</h5>
                                <strong><i>vs.</i> ${nextMatchData.opponent}</strong><br>
                                ${nextMatchData.date} h. ${nextMatchData.hour} <i>@${nextMatchData.at}</i>`;
        } else {
          matchDiv.innerHTML = "Nessuna partita in programma trovata.";
        }
        
        // Populate Player List
        const playerList = document.getElementById("player-list");
        playerList.innerHTML = "";
        data.players.forEach(player => {
            const div = document.createElement("div");
            div.className = "form-check";
            div.innerHTML = `<input class="form-check-input" type="checkbox" value="${player.id}" id="player-${player.id}">
                             <label class="form-check-label" for="player-${player.id}">${player.COGNOME} ${player.NOME}</label>`;
            playerList.appendChild(div);
        });

        playerList.addEventListener('change', function(event) {
          if (event.target.type === 'checkbox') {
            const count = document.querySelectorAll('#player-list input:checked').length;
            document.getElementById('player-counter').textContent = count;
          }
        });

        // Populate Staff Dropdowns
        const coachSelect = document.getElementById("coach-select");
        const directorSelect = document.getElementById("director-select");
        coachSelect.innerHTML = '<option value="">Seleziona Allenatore...</option>';
        directorSelect.innerHTML = '<option value="">Seleziona Dirigente...</option>';
        data.staff.forEach(staff => {
          const option = `<option value="${staff.id}">${staff.COGNOME} ${staff.NOME}</option>`;
          coachSelect.innerHTML += option;
          directorSelect.innerHTML += option;
        });

        // Show content
        document.getElementById('loader').style.display = 'none';
        // UPDATED: Show both cards
        document.getElementById('match-info').style.display = 'block';
        document.getElementById('main-content').style.display = 'block';
      }
      
      // Handle the button click
      document.getElementById("generate-btn").addEventListener("click", function() {
        if (!nextMatchData) {
            document.getElementById('status').textContent = 'Errore: Nessuna partita trovata.';
            return;
        }

        const statusDiv = document.getElementById('status');
        statusDiv.innerHTML = "🔄 Operazione in corso...";
        this.disabled = true;

        const selectedPlayers = Array.from(document.querySelectorAll('#player-list input:checked')).map(cb => cb.value);
        const coachId = document.getElementById('coach-select').value;
        let directorId = document.getElementById('director-select').value;

        if (!directorId) {
          directorId = coachId;
        }

        const formData = {
          matchData: nextMatchData,
          players: selectedPlayers,
          coachId: coachId,
          directorId: directorId
        };

        google.script.run.withSuccessHandler(onGenerationComplete).processDistintaGeneration(formData);
      });

      function onGenerationComplete(response) {
        const statusDiv = document.getElementById('status');
        // UPDATED to use alert divs for consistency
        if (response.success) {
          statusDiv.innerHTML = `<div class="alert alert-success">✅ Operazione completata! <a href="${response.url}" target="_blank">Apri la nuova distinta</a></div>`;
        } else {
          statusDiv.innerHTML = `<div class="alert alert-danger">❌ Errore: ${response.message}</div>`;
        }
        document.getElementById('generate-btn').disabled = false;
      }
    </script>
  </body>
</html>
